<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Próximas Guaguas</title>
    <link rel="icon" href="https://guaguasglobal.com/wp-content/uploads/favicon.ico" sizes="192x192" />
<link rel="apple-touch-icon" href="https://guaguasglobal.com/wp-content/uploads/favicon.ico" />
<meta name="msapplication-TileImage" content="https://guaguasglobal.com/wp-content/uploads/favicon.ico" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #008080;
            color: white;
        }
        .card {
            border-radius: 15px;
            background-color: #FFA500;
            border: none;
        }
        .card-header {
            background-color: #444;
            border-bottom: none;
        }
        .bus-item {
            padding: 15px;
            margin: 10px 0;
            background-color: #4A4A4A;
            border-radius: 10px;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
        }
        
        marquee {
            color: red; 
            font-weight: bold;
        }
        .text-custom-green {
            color: green; 
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card text-center">
                    <div class="card-header">
                        <h1>Próximas Llegadas de Guaguas</h1><br>
                        <img width="159px" height="70px" src="logo.png" />
                    </div>
                    <div class="card-body">
                        <div id="bus-info"></div>
                        <div id="error-message" class="text-danger mt-3"></div> <!-- Mensaje de error -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const busInfoContainer = document.getElementById('bus-info');
        const errorMessageContainer = document.getElementById('error-message');
    
        const apiUrl = 'https://cors-url-proxy.glitch.me/proxy?url=http://sat2globalapp.com:44040/App_MiLineaGlobal-Project-context-root/jersey/paradas/71052/vehiculoscercanos';
    
        function obtenerGuaguas(retries = 3) {
            const uniqueApiUrl = apiUrl + '?_=' + new Date().getTime();
        
            fetch(uniqueApiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta de la API: ' + response.statusText);
                    }
                    return response.text(); // Cambiado a text() para comprobar el contenido
                })
                .then(data => {
                    try {
                        const jsonData = JSON.parse(data); // Intentar convertir el texto a JSON
                        if (jsonData.Respuesta && jsonData.Respuesta.Vehiculos) {
                            mostrarGuaguas(jsonData.Respuesta.Vehiculos);
                            errorMessageContainer.innerText = ''; // Limpiar el mensaje de error
                        } else {
                            throw new Error('No se encontraron datos de guaguas.');
                        }
                    } catch (error) {
                        throw new Error('Error al analizar JSON: ' + error.message);
                    }
                })
                .catch(error => {
                    console.error('Error al obtener los datos:', error);
                    errorMessageContainer.innerText = 'Error al cargar las guaguas: ' + error.message;
        
                    if (retries > 0) {
                        console.log(`Reintentando... (${3 - retries + 1})`);
                        setTimeout(() => obtenerGuaguas(retries - 1), 2000);
                    }
                });
        }
        

    
        function mostrarGuaguas(guaguas) {
            busInfoContainer.innerHTML = ''; 
            guaguas.forEach(guagua => {
                const busItem = document.createElement('div');
                busItem.classList.add('bus-item');
    
                let tiempoTexto = guagua.Tiempo === "00:00" ? '<marquee>LLEGANDO</marquee>' : `<strong><span class="text-success">${guagua.Tiempo} minutos</span></strong>`;
    
                busItem.innerHTML = `
                    <div class="text-center">
                        <h3>${guagua.NombreLinea}</h3>
                        <p><strong>Destino:</strong> ${guagua.Destino}</p>
                        <p><strong>Tiempo estimado:</strong> </p>
                        <h4>${tiempoTexto}</h4>
                    </div>
                `;
    
                busInfoContainer.appendChild(busItem);
            });
        }
    
        obtenerGuaguas();
    
        setInterval(obtenerGuaguas, 7000); 
    </script>
    
</body>
</html>
